<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dashboard</title>

<style>
body { background-color:black; color:white; font-family:sans-serif; margin:0; padding:0; }
header { background-color:black; padding:20px; border-bottom:4px solid red; display:flex; justify-content:space-between; align-items:center; }
.header-left { display:flex; align-items:center; gap:15px; }
.logo { height:48px; width:auto; }
.header-title { font-size:32px; font-weight:bold; }
.tabs button { background:#222; color:white; border:1px solid red; padding:8px 16px; margin-right:10px; cursor:pointer; }
.tabs button:hover { background:red; }
.panel-title { color:red; font-size:24px; font-weight:bold; text-align:center; margin-top:20px; }
.service-row { display:flex; flex-direction:column; align-items:flex-start; background:#111; margin:10px 20px; padding:10px; border-left:6px solid red; }
.service-name { font-size:20px; font-weight:bold; }
.service-status { font-size:16px; color:lime; margin:5px 0; }
.service-buttons { display:flex; gap:10px; margin-top:8px; flex-wrap:wrap; }
.service-buttons button { padding:6px 12px; font-size:14px; font-weight:bold; border:none; border-radius:4px; cursor:pointer; }
.service-buttons button:nth-child(1) { background:lightgray; color:black; }
.service-buttons button:nth-child(2) { background:gold; color:black; }
.service-buttons button:nth-child(3) { background:red; color:white; }
.log-toggle { background:#333; color:white; }
.log-box { width:99%; background:#000; border:1px solid red; margin-top:10px; padding:10px; display:none; max-height:300px; overflow-y:auto; }
.log-content { white-space:pre-wrap; font-family:monospace; font-size:13px; color:#ccc; }

.config-toolbar { display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin:10px 20px; }
.config-row { display:flex; align-items:center; gap:8px; margin:6px 0; }
.config-row label { width:260px; color:#ccc; font-size:14px; }
.config-row input { flex:0 0 50%; max-width:50%; padding:6px; background:#000; color:#fff; border:1px solid #444; }
.config-path { color:#888; font-size:12px; margin-left:10px; }
.config-status-inline { color:#ccc; margin-left:auto; text-align:right; }

.btn-secondary { background:#444; color:white; font-weight:bold; padding:8px 14px; border:none; border-radius:4px; cursor:pointer; }
.btn-tertiary { background:#222; color:white; font-weight:bold; padding:8px 14px; border:1px solid #444; border-radius:4px; cursor:pointer; }
.btn-danger { background:#a00; color:white; font-weight:bold; padding:8px 14px; border:none; border-radius:4px; cursor:pointer; }
</style>
</head>

<body>

<header>
 <div class="header-left">
   <img src="/logo.png" class="logo" alt="logo">
   <div class="header-title"></div>
 </div>
 <nav class="tabs">
   <button onclick="showTab('sindenlog')">Sinden Log</button>
   <button onclick="showTab('services')">Services</button>
   <button onclick="showTab('config')">Configuration</button>
 </nav>
</header>


<!-- SINDEN LOG -->
<div id="tab-sindenlog" style="display:block; padding:5px;">
 <h2 class="panel-title">LightGun.Service Log</h2>
 <div class="log-box" style="display:block; max-height:500px;">
   <pre id="sinden-log-content" class="log-content">Loading…</pre>
 </div>
</div>


<!-- SERVICES PANEL -->
<div id="service-panel" style="display:none;">
 <h2 class="panel-title">Service Monitor</h2>

 <div class="service-row" id="service-lightgun">
   <span class="service-name">lightgun.service</span>
   <span class="service-status">loading…</span>
   <div class="service-buttons">
     <button onclick="serviceAction('lightgun.service','start')">Start</button>
     <button onclick="serviceAction('lightgun.service','stop')">Stop</button>
     <button onclick="serviceAction('lightgun.service','restart')">Restart</button>
     <button class="log-toggle" onclick="toggleLogs(event,'lightgun.service')">Show Logs</button>
   </div>
   <div class="log-box" id="logs-lightgun">
     <pre class="log-content">Loading…</pre>
   </div>
 </div>

 <div class="service-row" id="service-lightgun-monitor">
   <span class="service-name">lightgun-monitor.service</span>
   <span class="service-status">loading…</span>
   <div class="service-buttons">
     <button onclick="serviceAction('lightgun-monitor.service','start')">Start</button>
     <button onclick="serviceAction('lightgun-monitor.service','stop')">Stop</button>
     <button onclick="serviceAction('lightgun-monitor.service','restart')">Restart</button>
     <button class="log-toggle" onclick="toggleLogs(event,'lightgun-monitor.service')">Show Logs</button>
   </div>
   <div class="log-box" id="logs-lightgun-monitor">
     <pre class="log-content">Loading…</pre>
   </div>
 </div>

</div>


<!-- CONFIG PANEL -->
<div id="tab-config" style="display:none; padding:10px;">
 <h2 class="panel-title">Sinden LightGun Driver Configuration</h2>

 <div class="config-toolbar">
   <label>Platform:</label>
   <select id="platform-select">
     <option value="ps2" selected>PlayStation 2</option>
     <option value="ps1">PlayStation 1</option>
   </select>

   <label>Profile:</label>
   <select id="profile-select">
     <option value="">(none)</option>
   </select>

   <button id="btn-activate-profile" class="btn-danger">Activate Profile</button>
   <button id="btn-save-profile" class="btn-secondary">Save as Profile</button>

   <span id="config-file-path" class="config-path"></span>
   <span id="config-status" class="config-status-inline"></span>
   <button id="save-restart" class="btn-danger">Save & Restart</button>
 </div>

 <div style="display:flex; gap:16px; flex-wrap:wrap;">
   <div style="flex:1 1 460px; background:#111; border-left:6px solid red; padding:12px;">
     <div class="service-name">Player 1</div>
     <div id="p1-form" class="config-form"></div>
   </div>

   <div style="flex:1 1 460px; background:#111; border-left:6px solid red; padding:12px;">
     <div class="service-name">Player 2</div>
     <div id="p2-form" class="config-form"></div>
   </div>
 </div>
</div>


<script>
/* JS FUNCTIONS — SAME FUNCTIONALITY, CLEANED AND ERROR-FREE */

function showTab(name) {
  document.getElementById("service-panel").style.display = (name === "services") ? "block" : "none";
  document.getElementById("tab-sindenlog").style.display = (name === "sindenlog") ? "block" : "none";
  document.getElementById("tab-config").style.display = (name === "config") ? "block" : "none";
  if (name === "sindenlog") loadSindenLog();
  if (name === "config") {
    const p = document.getElementById("platform-select").value;
    loadConfig(p);
    refreshProfilesUI(p);
  }
}

async function serviceAction(name, action) {
  await fetch(`/api/service/${name}/${action}`, { method: "POST" });
  refreshServices();
}

async function refreshServices() {
  const res = await fetch("/api/services");
  const data = await res.json();
  for (const [svc, status] of Object.entries(data)) {
    const el = document.querySelector(`#service-${svc.replace(".service","")} .service-status`);
    if (el) el.textContent = status;
  }
}

function toggleLogs(e, svc) {
  const box = document.getElementById("logs-" + svc.replace(".service", ""));
  if (box.style.display === "block") {
    box.style.display = "none";
    e.target.textContent = "Show Logs";
  } else {
    box.style.display = "block";
    e.target.textContent = "Hide Logs";
    loadLogs(svc);
  }
}

async function loadLogs(svc) {
  const res = await fetch(`/api/logs/${svc}`);
  const data = await res.json();
  const box = document.querySelector(`#logs-${svc.replace(".service","")} .log-content`);
  box.textContent = data.logs || "";
}

async function loadSindenLog() {
  const res = await fetch("/api/sinden-log");
  const data = await res.json();
  const box = document.getElementById("sinden-log-content");
  box.textContent = data.logs || "";
}

async function loadConfig(platform) {
  const res = await fetch(`/api/config?platform=${platform}`);
  const data = await res.json();
  document.getElementById("config-file-path").textContent = "File: " + data.path;
  buildConfigForm("p1-form", data.player1);
  buildConfigForm("p2-form", data.player2);
}

function buildConfigForm(id, list) {
  const div = document.getElementById(id);
  div.innerHTML = "";
  list.forEach(item => {
    const row = document.createElement("div");
    row.className = "config-row";
    row.innerHTML = `<label>${item.key}</label><input data-key="${item.key}" value="${item.value}">`;
    div.appendChild(row);
  });
}

function collectForm(id) {
  return [...document.querySelectorAll(`#${id} input`)].map(i => ({
    key: i.dataset.key,
    value: i.value
  }));
}

async function saveConfig(platform, p1, p2) {
  const res = await fetch("/api/config/save", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ platform, player1:p1, player2:p2 })
  });
  return res.json();
}

async function restartLightgunService() {
  const res = await fetch("/api/service/lightgun.service/restart", { method:"POST" });
  const data = await res.json();
  return data.success;
}

async function listProfiles(platform) {
  const res = await fetch(`/api/config/profiles?platform=${platform}`);
  const data = await res.json();
  return data.profiles || [];
}

async function refreshProfilesUI(platform) {
  const profiles = await listProfiles(platform);
  const sel = document.getElementById("profile-select");
  sel.innerHTML = `<option value="">(none)</option>`;
  profiles.forEach(p => {
    const o = document.createElement("option");
    o.value = p.name;
    o.textContent = p.name;
    sel.appendChild(o);
  });
}

async function activateProfile(platform, name) {
  if (!name) return alert("Pick a profile first.");
  const res = await fetch("/api/config/profile/load", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ platform, name })
  });
  const data = await res.json();
  if (data.ok) restartLightgunService();
}

document.getElementById("btn-save-profile").onclick = async () => {
  const platform = document.getElementById("platform-select").value;
  const name = prompt("Profile name:");
  if (!name) return;
  await fetch("/api/config/profile/save", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ platform, name })
  });
  refreshProfilesUI(platform);
};

document.getElementById("btn-activate-profile").onclick = () => {
  const platform = document.getElementById("platform-select").value;
  const profile = document.getElementById("profile-select").value;
  activateProfile(platform, profile);
};

document.getElementById("save-restart").onclick = async () => {
  const p = document.getElementById("platform-select").value;
  const p1 = collectForm("p1-form");
  const p2 = collectForm("p2-form");
  await saveConfig(p, p1, p2);
  restartLightgunService();
};

setInterval(refreshServices, 1000);
showTab("sindenlog");
</script>

</body>
</html>