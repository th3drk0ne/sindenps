<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<style>
body { background-color:black; color:white; font-family:sans-serif; margin:0; padding:0; }
header { background-color:black; padding:20px; border-bottom:4px solid red; display:flex; justify-content:space-between; align-items:center; }
.header-left { display:flex; align-items:center; gap:15px; }
.logo { height:48px; width:auto; }
.header-title { font-size:32px; font-weight:bold; }
.tabs button { background:#222; color:white; border:1px solid red; padding:8px 16px; margin-right:10px; cursor:pointer; }
.tabs button:hover { background:red; }
.panel-title { color:red; font-size:24px; font-weight:bold; text-align:center; margin-top:20px; }
.service-row { display:flex; flex-direction:column; align-items:flex-start; background:#111; margin:10px 20px; padding:10px; border-left:6px solid red; }
.service-name { font-size:20px; font-weight:bold; }
.service-status { font-size:16px; color:lime; margin:5px 0; }
.service-buttons { display:flex; gap:10px; margin-top:8px; }
.service-buttons button { padding:6px 12px; font-size:14px; font-weight:bold; border:none; border-radius:4px; cursor:pointer; }
.service-buttons button:nth-child(1) { background:lightgray; color:black; }
.service-buttons button:nth-child(2) { background:gold; color:black; }
.service-buttons button:nth-child(3) { background:red; color:white; }
.log-toggle { background:#333; color:white; }
.log-box { width:99%; background:#000; border:1px solid red; margin-top:10px; padding:10px; display:none; max-height:300px; overflow-y:auto; }
.log-content { white-space:pre-wrap; font-family:monospace; font-size:13px; color:#ccc; }
/* Config */
.config-toolbar { display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin:10px 20px; }
.config-toolbar label { color:#ccc; }
.config-row { display:flex; align-items:center; gap:8px; margin:6px 0; }
.config-row label { width:260px; color:#ccc; font-size:14px; }
.config-row input { flex:0 0 50%; max-width:50%; padding:6px; background:#000; color:#fff; border:1px solid #444; }
.config-path { color:#888; font-size:12px; margin-left:10px; }
</style>
</head>
<body>
<header>
  <div class="header-left">
    <img src="logo.png" class="logo" alt="logo">
    <div class="header-title">Dashboard</div>
  </div>
  <nav class="tabs">
    <button onclick="showTab('sindenlog')">Sinden Log</button>
    <button onclick="showTab('services')">Services</button>
    <button onclick="showTab('config')">Configuration</button>
  </nav>
</header>

<!-- SERVICES -->
<div id="service-panel" style="display:none;">
  <h2 class="panel-title">Service Monitor</h2>
  <div class="service-row" id="service-lightgun">
    <span class="service-name">lightgun.service</span>
    <span class="service-status">loading…</span>
    <div class="service-buttons">
      <button onclick="serviceAction('lightgun.service','start')">Start</button>
      <button onclick="serviceAction('lightgun.service','stop')">Stop</button>
      <button onclick="serviceAction('lightgun.service','restart')">Restart</button>
      <button class="log-toggle" onclick="toggleLogs('lightgun.service')">Show Logs</button>
    </div>
    <div class="log-box" id="logs-lightgun">
      <pre class="log-content">Loading…</pre>
    </div>
  </div>
  <div class="service-row" id="service-lightgun-monitor">
    <span class="service-name">lightgun-monitor.service</span>
    <span class="service-status">loading…</span>
    <div class="service-buttons">
      <button onclick="serviceAction('lightgun-monitor.service','start')">Start</button>
      <button onclick="serviceAction('lightgun-monitor.service','stop')">Stop</button>
      <button onclick="serviceAction('lightgun-monitor.service','restart')">Restart</button>
      <button class="log-toggle" onclick="toggleLogs('lightgun-monitor.service')">Show Logs</button>
    </div>
    <div class="log-box" id="logs-lightgun-monitor">
      <pre class="log-content">Loading…</pre>
    </div>
  </div>
</div>

<!-- SINDEN LOG -->
<div id="tab-sindenlog" style="display:block; padding:5px;">
  <h2 class="panel-title">LightGun.Service Log</h2>
  <div class="log-box" style="display:block; max-height:500px;">
    <pre id="sinden-log-content" class="log-content">Loading…</pre>
  </div>
</div>

<!-- CONFIG -->
<div id="tab-config" style="display:none; padding:10px;">
  <h2 class="panel-title">Sinden LightGun Driver Configuration</h2>
  <div class="config-toolbar">
    <label for="platform-select">Platform:</label>
    <select id="platform-select">
      <option value="ps2" selected>PlayStation 2</option>
      <option value="ps1">PlayStation 1</option>
    </select>
    <span id="config-file-path" class="config-path"></span>
  </div>

  <div style="display:flex; gap:16px; flex-wrap:wrap;">
    <div style="flex:1 1 460px; background:#111; border-left:6px solid red; padding:12px;">
      <div class="service-name">Player 1</div>
      <div id="p1-form" class="config-form" style="margin-top:8px;"></div>
    </div>
    <div style="flex:1 1 460px; background:#111; border-left:6px solid red; padding:12px;">
      <div class="service-name">Player 2</div>
      <div id="p2-form" class="config-form" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Single Save & Restart button -->
  <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
    <button id="save-restart" style="background:red; color:white; font-weight:bold;">Save & Restart</button>
    <span id="config-status" style="color:#ccc;"></span>
  </div>
</div>

<script>
function showTab(name) {
  document.getElementById("service-panel").style.display =
    name === "services" ? "block" : "none";
  document.getElementById("tab-sindenlog").style.display =
    name === "sindenlog" ? "block" : "none";
  const cfg = document.getElementById("tab-config");
  if (cfg) cfg.style.display = name === "config" ? "block" : "none";
  if (name === "sindenlog") loadSindenLog();
  if (name === "config") {
    const sel=document.getElementById("platform-select");
    loadConfig(sel.value).catch(err => {
      const s=document.getElementById("config-status");
      if (s) s.textContent = "Load error: " + err.message;
    });
  }
}
async function refreshServices() {
  const res = await fetch("/api/services");
  const data = await res.json();
  for (const [name, status] of Object.entries(data)) {
    const row = document.getElementById("service-" + name.replace(".service",""));
    if (!row) continue;
    const statusEl = row.querySelector(".service-status");
    statusEl.textContent = status;
    statusEl.className = "service-status " + status;
  }
}
async function serviceAction(name, action) {
  await fetch(`/api/service/${name}/${action}`, { method: "POST" });
  refreshServices();
}
async function loadLogs(service) {
  const box = document.getElementById("logs-" + service.replace(".service",""));
  const content = box.querySelector(".log-content");
  const res = await fetch(`/api/logs/${service}`);
  const data = await res.json();
  content.textContent = (data && data.logs) ? data.logs : "No logs available";
}
function toggleLogs(service) {
  const box = document.getElementById("logs-" + service.replace(".service",""));
  const btn = event.target;
  if (box.style.display === "block") {
    box.style.display = "none";
    btn.textContent = "Show Logs";
  } else {
    box.style.display = "block";
    btn.textContent = "Hide Logs";
    loadLogs(service);
  }
}
async function loadSindenLog() {
  const res = await fetch("/api/sinden-log");
  const data = await res.json();
  const box = document.getElementById("sinden-log-content");
  box.textContent = data.logs;
  box.parentElement.scrollTop = box.parentElement.scrollHeight;
}
/* === Config (PS1/PS2), preserving XML order === */
document.addEventListener("DOMContentLoaded", () => {
  const sel = document.getElementById("platform-select");
  sel.addEventListener("change", () => {
    loadConfig(sel.value).catch(err => {
      const s=document.getElementById("config-status");
      if (s) s.textContent = "Load error: " + err.message;
    });
  });
});
async function loadConfig(platform) {
  const res = await fetch(`/api/config?platform=${encodeURIComponent(platform)}`);
  const data = await res.json();
  if (!data.ok) throw new Error(data.error || "Failed to read config");
  document.getElementById("config-file-path").textContent = data.path ? `File: ${data.path}` : "";
  buildConfigForm("p1-form", data.player1);
  buildConfigForm("p2-form", data.player2);
}
function buildConfigForm(containerId, kvList) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";
  kvList.forEach(item => {
    const row = document.createElement("div");
    row.className = "config-row";
    const label = document.createElement("label");
    label.textContent = item.key;
    const input = document.createElement("input");
    input.value = item.value ?? "";
    input.dataset.key = item.key;
    row.appendChild(label);
    row.appendChild(input);
    container.appendChild(row);
  });
}
function collectForm(containerId) {
  return [...document.getElementById(containerId).querySelectorAll("input[data-key]")]
    .map(i => ({ key: i.dataset.key, value: i.value }));
}
async function saveConfig(platform, p1List, p2List) {
  const res = await fetch("/api/config/save", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ platform, player1: p1List, player2: p2List })
  });
  return await res.json();
}
async function restartLightgunService() {
  try {
    const res = await fetch('/api/service/lightgun.service/restart', { method: 'POST' });
    const data = await res.json();
    return data && data.success;
  } catch (e) {
    return false;
  }
}
document.addEventListener("DOMContentLoaded", () => {
  const status = document.getElementById("config-status");
  const sel = document.getElementById("platform-select");
  const btn = document.getElementById("save-restart");
  if (btn) btn.onclick = async () => {
    btn.disabled = true;
    try {
      status.textContent = "Saving configuration (both players)...";
      const d = await saveConfig(sel.value, collectForm("p1-form"), collectForm("p2-form"));
      if (!d.ok) {
        status.textContent = `Error saving: ${d.error}`;
        return;
      }
      status.textContent = `Saved. Backup: ${d.backup ?? "n/a"}. Restarting lightgun.service...`;
      const ok = await restartLightgunService();
      status.textContent = ok ? "Saved and restarted successfully." : "Saved. Restart failed.";
      refreshServices();
    } finally {
      btn.disabled = false;
    }
  };
});
setInterval(() => {
  ["lightgun.service", "lightgun-monitor.service"].forEach(s => {
    const box = document.getElementById("logs-" + s.replace(".service",""));
    if (box && box.style.display === "block") loadLogs(s);
  });
  if (document.getElementById("tab-sindenlog").style.display === "block") {
    loadSindenLog();
  }
}, 3000);
setInterval(refreshServices, 3000);
/* Default to Sinden Log on first load */
showTab('sindenlog');
refreshServices();
</script>
</body>
</html>