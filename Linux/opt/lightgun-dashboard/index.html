<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lightgun Dashboard — Services</title>

  <!-- Page styles (kept minimal; matches your dark theme) -->
  <style>
    body { background:#0b0b0b; color:#ddd; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif; }
    header { padding: 1rem; border-bottom: 1px solid #333; display:flex; align-items:center; gap:1rem; }
    header img { height: 32px; }
    main { padding: 1rem; max-width: 1100px; margin: 0 auto; }
    h2, h3, h4 { color:#fff; }

    .panel { border: 1px solid #444; padding: 1rem; margin-top: 1rem; background: #111; }
    .form-row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
    .form-row label { display: flex; flex-direction: column; font-size: 0.9rem; }
    .log-output { margin-top: 0.75rem; max-height: 300px; overflow: auto; background: #000; color: #0f0; padding: 0.5rem; font-family: monospace; font-size: 0.85rem; }

    .btn { border:none; padding:0.4rem 0.8rem; cursor:pointer; }
    .btn-danger { background: #b30000; color: #fff; }
    .btn-secondary { background: #666; color: #fff; }
    .btn-warning { background: #cc8800; color: #fff; }

    .progress { width: 100%; height: 16px; background: #222; border: 1px solid #444; margin: 0.5rem 0; }
    .progress-bar { height: 100%; background: #2e8b57; width: 0%; transition: width .2s ease; }
    .step-text { color: #ddd; font-size: 0.9rem; }

    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #333; padding: 0.5rem; text-align: left; }
    .svc-status { font-weight:bold; }
  </style>
</head>
<body>
  <!-- ===== HEADER ===== -->
  <header>
    <img src="/logo.png" alt="logo" />
    <h2>Lightgun Dashboard</h2>
  </header>

  <main>
    <!-- ===== SERVICES OVERVIEW (existing tab) ===== -->
    <section class="panel">
      <h3>Services</h3>
      <table>
        <thead>
          <tr><th>Service</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody id="svc-table"></tbody>
      </table>
      <pre id="svc-logs" class="log-output"></pre>
    </section>

    <!-- ===== DRIVER SWITCH (new panel with progress + cancel) ===== -->
    <section id="driver-switch" class="panel">
      <h3>Driver Switch</h3>

      <div class="form-row">
        <label>Version
          <select id="drv-version">
            <option value="latest">Latest</option>
            <option value="psiloc">Psiloc (Legacy)</option>
            <option value="beta">Beta</option>
            <option value="previous">Previous</option>
          </select>
        </label>

        <label>Owner
          <input id="drv-owner" type="text" value="th3drk0ne">
        </label>

        <label>Repo
          <input id="drv-repo" type="text" value="sindenps">
        </label>

        <label>Branch
          <input id="drv-branch" type="text" value="main">
        </label>

        <button id="drv-start" class="btn btn-danger">Switch Driver</button>
        <button id="drv-cancel" class="btn btn-secondary" disabled>Cancel</button>
      </div>

      <!-- Progress -->
      <div id="drv-progress" class="progress">
        <div id="drv-progress-bar" class="progress-bar" style="width:0%"></div>
      </div>
      <div id="drv-step" class="step-text">Idle</div>
      <pre id="drv-log" class="log-output"></pre>

      <!-- ===== ROLLBACK OPTIONS ===== -->
      <h4 style="margin-top:1rem;">Rollback Options</h4>

      <!-- Quick rollback (latest backup for selected platform) -->
      <div class="form-row">
        <label>Platform
          <select id="rb-platform">
            <option value="ps2">PS2 (default)</option>
            <option value="ps1">PS1</option>
          </select>
        </label>
        <button id="rb-quick" class="btn btn-warning">Quick Rollback (Latest)</button>
      </div>

      <!-- Select-and-restore for PS1 -->
      <div class="form-row">
        <label>Choose Backup (PS1)</label>
        <select id="rb-ps1-list"></select>
        <button id="rb-ps1-restore" class="btn btn-warning">Restore Selected</button>
      </div>

      <!-- Select-and-restore for PS2 -->
      <div class="form-row">
        <label>Choose Backup (PS2)</label>
        <select id="rb-ps2-list"></select>
        <button id="rb-ps2-restore" class="btn btn-warning">Restore Selected</button>
      </div>

      <pre id="rb-output" class="log-output"></pre>
    </section>

    <!-- ===== SINDEN LOG VIEWER ===== -->
    <section class="panel">
      <h3>Sinden Log</h3>
      <button id="load-log" class="btn btn-secondary">Load Log</button>
      <pre id="sinden-log" class="log-output"></pre>
    </section>
  </main>

  <!-- ===== PAGE SCRIPT (talks to your Flask API) ===== -->
  <script>
  const el = id => document.getElementById(id);

  // -------- Services table ---------
  async function refreshServices() {
    try {
      const res = await fetch('/api/services');
      const data = await res.json();
      const tbody = el('svc-table');
      tbody.innerHTML = '';
      Object.entries(data).forEach(([name, status]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${name}</td>
          <td class="svc-status">${status}</td>
          <td>
            <button class="btn btn-secondary" data-svc="${name}" data-act="start">Start</button>
            <button class="btn btn-secondary" data-svc="${name}" data-act="stop">Stop</button>
            <button class="btn btn-secondary" data-svc="${name}" data-act="restart">Restart</button>
            <button class="btn" data-svc="${name}" data-act="logs">Logs</button>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button').forEach(btn => btn.addEventListener('click', async (e) => {
        const svc = e.target.getAttribute('data-svc');
        const act = e.target.getAttribute('data-act');
        try {
          if (act === 'logs') {
            const r = await fetch(`/api/logs/${svc}`);
            const j = await r.json();
            el('svc-logs').textContent = j.logs || '';
            return;
          }
          const r = await fetch(`/api/service/${svc}/${act}`, { method: 'POST' });
          await r.json();
          refreshServices();
        } catch (err) {
          console.error(err);
        }
      }));
    } catch (err) { console.error('Services refresh failed', err); }
  }

  // -------- Driver defaults ---------
  async function loadDriverDefaults() {
    try {
      const res = await fetch('/api/driver/versions');
      const data = await res.json();
      if (data?.defaults) {
        el('drv-owner').value  = data.defaults.owner;
        el('drv-repo').value   = data.defaults.repo;
        el('drv-branch').value = data.defaults.branch;
      }
    } catch (err) { console.warn('Driver defaults load failed', err); }
  }

  // -------- Progress helpers ---------
  function setProgress(pct, step) {
    el('drv-progress-bar').style.width = `${Math.max(0, Math.min(100, pct))}%`;
    if (step) el('drv-step').textContent = step;
  }
  function appendLog(lines) {
    if (!lines || !lines.length) return;
    const out = el('drv-log');
    out.textContent += (Array.isArray(lines) ? lines.join('\n') : lines) + '\n';
    out.scrollTop = out.scrollHeight;
  }

  // Async driver switch task polling
  let currentTaskId = null;
  let pollingTimer = null;

  async function pollStatus() {
    if (!currentTaskId) return;
    try {
      const res = await fetch(`/api/driver/switch/status/${currentTaskId}`);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'status error');

      const t = data.task;
      setProgress(t.percent || 0, t.step || 'working');
      appendLog(t.logs || []);
      el('drv-cancel').disabled = !!t.done;

      if (t.done) {
        clearInterval(pollingTimer);
        pollingTimer = null;
        currentTaskId = null;

        if (t.error) {
          appendLog(`ERROR: ${t.error}`);
          el('drv-step').textContent = 'Failed';
          setProgress(t.percent || 100, 'Failed');
        } else {
          appendLog('Completed successfully.');
          el('drv-step').textContent = 'Completed';
          setProgress(100, 'Completed');
          refreshServices();
        }
      }
    } catch (err) {
      clearInterval(pollingTimer);
      pollingTimer = null;
      currentTaskId = null;
      appendLog(`STATUS ERROR: ${err}`);
      el('drv-step').textContent = 'Error';
    }
  }

  // Start driver switch
  el('drv-start').addEventListener('click', async () => {
    if (!confirm('This will replace driver files and restart services. Continue?')) return;

    el('drv-start').disabled = true;
    el('drv-cancel').disabled = true;
    el('drv-log').textContent = '';
    setProgress(0, 'Starting…');

    const payload = {
      version: el('drv-version').value,
      owner:   el('drv-owner').value.trim(),
      repo:    el('drv-repo').value.trim(),
      branch:  el('drv-branch').value.trim()
    };

    try {
      const res = await fetch('/api/driver/switch', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if (!j.ok) throw new Error(j.error || 'start failed');

      currentTaskId = j.task_id;
      el('drv-cancel').disabled = false;
      pollingTimer = setInterval(pollStatus, 1000);
    } catch (err) {
      appendLog(`START ERROR: ${err}`);
      el('drv-step').textContent = 'Error';
    } finally {
      el('drv-start').disabled = false;
    }
  });

  // Cancel
  el('drv-cancel').addEventListener('click', async () => {
    if (!currentTaskId) return;
    try {
      await fetch(`/api/driver/switch/cancel/${currentTaskId}`, { method: 'POST' });
      appendLog('Cancellation requested.');
    } catch (err) {
      appendLog('Cancel failed: ' + err);
    }
  });

  // -------- Rollback (Quick latest) ---------
  el('rb-quick').addEventListener('click', async () => {
    const platform = el('rb-platform').value;
    el('rb-output').textContent = `Quick rollback on ${platform}…`;
    try {
      const res = await fetch('/api/driver/rollback/latest', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ platform })
      });
      const j = await res.json();
      el('rb-output').textContent = JSON.stringify(j, null, 2);
    } catch (err) {
      el('rb-output').textContent = 'ERROR: ' + err;
    }
  });

  // -------- Rollback (select backup for PS1/PS2) ---------
  async function loadBackupLists() {
    try {
      // PS1 backups
      const r1 = await fetch('/api/config/backups?platform=ps1');
      const j1 = await r1.json();
      const sel1 = el('rb-ps1-list');
      sel1.innerHTML = '';
      (j1.backups || []).forEach(b => {
        const opt = document.createElement('option');
        opt.value = b.name;
        opt.textContent = `${new Date(b.mtime*1000).toLocaleString()} — ${b.name} (${b.size} bytes)`;
        sel1.appendChild(opt);
      });

      // PS2 backups
      const r2 = await fetch('/api/config/backups?platform=ps2');
      const j2 = await r2.json();
      const sel2 = el('rb-ps2-list');
      sel2.innerHTML = '';
      (j2.backups || []).forEach(b => {
        const opt = document.createElement('option');
        opt.value = b.name;
        opt.textContent = `${new Date(b.mtime*1000).toLocaleString()} — ${b.name} (${b.size} bytes)`;
        sel2.appendChild(opt);
      });
    } catch (err) {
      el('rb-output').textContent = 'ERROR loading backups: ' + err;
    }
  }

  el('rb-ps1-restore').addEventListener('click', async () => {
    const filename = el('rb-ps1-list').value;
    if (!filename) return;
    el('rb-output').textContent = `Restoring PS1 backup: ${filename}`;
    try {
      const res = await fetch('/api/config/backup/restore', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ platform: 'ps1', filename })
      });
      const j = await res.json();
      el('rb-output').textContent = JSON.stringify(j, null, 2);
    } catch (err) {
      el('rb-output').textContent = 'ERROR: ' + err;
    }
  });

  el('rb-ps2-restore').addEventListener('click', async () => {
    const filename = el('rb-ps2-list').value;
    if (!filename) return;
    el('rb-output').textContent = `Restoring PS2 backup: ${filename}`;
    try {
      const res = await fetch('/api/config/backup/restore', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ platform: 'ps2', filename })
      });
      const j = await res.json();
      el('rb-output').textContent = JSON.stringify(j, null, 2);
    } catch (err) {
      el('rb-output').textContent = 'ERROR: ' + err;
    }
  });

  // -------- Sinden log viewer ---------
  el('load-log').addEventListener('click', async () => {
    try {
      const r = await fetch('/api/sinden-log');
      const j = await r.json();
      el('sinden-log').textContent = j.logs || '';
    } catch (err) {
      el('sinden-log').textContent = 'ERROR: ' + err;
    }
  });

  // Initial loads
  refreshServices();
  loadDriverDefaults();
  loadBackupLists();
  </script>
</body>
</html>