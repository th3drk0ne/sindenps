
#-----------------------------------------------------------
# Lightgun Dashboard - Setup (PS1/PS2 Configuration support)
#-----------------------------------------------------------
#!/bin/bash
set -e

echo "=== Installing system packages ==="
sudo apt update
sudo apt install -y python3 python3-pip python3-venv git nginx wget lsof

echo "=== Creating dashboard directory ==="
sudo mkdir -p /opt/lightgun-dashboard
sudo chown -R sinden:sinden /opt/lightgun-dashboard

echo "=== Writing updated index.html to /opt/lightgun-dashboard ==="
sudo bash -c 'cat > /opt/lightgun-dashboard/index.html' <<'INDEX_EOF'
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Lightgun Dashboard</title>
<style>
body { background-color:black; color:white; font-family:sans-serif; margin:0; padding:0; }
header { background-color:black; padding:20px; border-bottom:4px solid red; display:flex; justify-content:space-between; align-items:center; }
.header-left { display:flex; align-items:center; gap:15px; }
.logo { height:48px; width:auto; }
.header-title { font-size:32px; font-weight:bold; }
.tabs button { background:#222; color:white; border:1px solid red; padding:8px 16px; margin-right:10px; cursor:pointer; }
.tabs button:hover { background:red; }
.panel-title { color:red; font-size:24px; font-weight:bold; text-align:center; margin-top:20px; }
.service-row { display:flex; flex-direction:column; align-items:flex-start; background:#111; margin:10px 20px; padding:10px; border-left:6px solid red; }
.service-name { font-size:20px; font-weight:bold; }
.service-status { font-size:16px; color:lime; margin:5px 0; }
.service-buttons { display:flex; gap:10px; margin-top:8px; }
.service-buttons button { padding:6px 12px; font-size:14px; font-weight:bold; border:none; border-radius:4px; cursor:pointer; }
.service-buttons button:nth-child(1) { background:lightgray; color:black; }
.service-buttons button:nth-child(2) { background:gold; color:black; }
.service-buttons button:nth-child(3) { background:red; color:white; }
.log-toggle { background:#333; color:white; }
.log-box { width:99%; background:#000; border:1px solid red; margin-top:10px; padding:10px; display:none; max-height:300px; overflow-y:auto; }
.log-content { white-space:pre-wrap; font-family:monospace; font-size:13px; color:#ccc; }

/* Config tab */
.config-toolbar { display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin:10px 20px; }
.config-toolbar label { color:#ccc; }
.config-row { display:flex; align-items:center; gap:8px; margin:6px 0; }
.config-row label { width:260px; color:#ccc; font-size:14px; }
.config-row input { flex:1; padding:6px; background:#000; color:#fff; border:1px solid #444; }
.config-path { color:#888; font-size:12px; margin-left:10px; }
</style>
</head>
<body>
<header>
  <div class="header-left">
    <img src="logo.png" class="logo" alt="logo">
    <div class="header-title">Lightgun Dashboard</div>
  </div>
  <nav class="tabs">
    <button onclick="showTab('services')">Services</button>
    <button onclick="showTab('sindenlog')">Sinden Log</button>
    <button onclick="showTab('config')">Configuration</button>
  </nav>
</header>

<!-- SERVICES PANEL (hidden by default; default is Sinden Log) -->
<div id="service-panel" style="display:none;">
  <h2 class="panel-title">Service Monitor</h2>

  <div class="service-row" id="service-lightgun">
    <span class="service-name">lightgun.service</span>
    <span class="service-status">loading…</span>
    <div class="service-buttons">
      <button onclick="serviceAction('lightgun.service','start')">Start</button>
      <button onclick="serviceAction('lightgun.service','stop')">Stop</button>
      <button onclick="serviceAction('lightgun.service','restart')">Restart</button>
      <button class="log-toggle" onclick="toggleLogs('lightgun.service')">Show Logs</button>
    </div>
    <div class="log-box" id="logs-lightgun">
      <pre class="log-content">Loading…</pre>
    </div>
  </div>

  <div class="service-row" id="service-lightgun-monitor">
    <span class="service-name">lightgun-monitor.service</span>
    <span class="service-status">loading…</span>
    <div class="service-buttons">
      <button onclick="serviceAction('lightgun-monitor.service','start')">Start</button>
      <button onclick="serviceAction('lightgun-monitor.service','stop')">Stop</button>
      <button onclick="serviceAction('lightgun-monitor.service','restart')">Restart</button>
      <button class="log-toggle" onclick="toggleLogs('lightgun-monitor.service')">Show Logs</button>
    </div>
    <div class="log-box" id="logs-lightgun-monitor">
      <pre class="log-content">Loading…</pre>
    </div>
  </div>
</div>

<!-- SINDEN LOG PANEL (visible by default) -->
<div id="tab-sindenlog" style="display:block; padding:5px;">
  <h2 class="panel-title">LightGun.Service Log</h2>
  <div class="log-box" style="display:block; max-height:500px;">
    <pre id="sinden-log-content" class="log-content">Loading…</pre>
  </div>
</div>

<!-- CONFIGURATION PANEL -->
<div id="tab-config" style="display:none; padding:10px;">
  <h2 class="panel-title">Configuration</h2>

  <div class="config-toolbar">
    <label for="platform-select">Platform:</label>
    <select id="platform-select">
      <option value="ps2" selected>PlayStation 2</option>
      <option value="ps1">PlayStation 1</option>
    </select>
    <span id="config-file-path" class="config-path"></span>
  </div>

  <div style="display:flex; gap:16px; flex-wrap:wrap;">
    <div style="flex:1 1 460px; background:#111; border-left:6px solid red; padding:12px;">
      <div class="service-name">Player 1</div>
      <div id="p1-form" class="config-form" style="margin-top:8px;"></div>
      <button id="save-p1" style="margin-top:10px;">Save Player 1</button>
    </div>
    <div style="flex:1 1 460px; background:#111; border-left:6px solid red; padding:12px;">
      <div class="service-name">Player 2</div>
      <div id="p2-form" class="config-form" style="margin-top:8px;"></div>
      <button id="save-p2" style="margin-top:10px;">Save Player 2</button>
    </div>
  </div>
  <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
    <button id="save-both">Save Both Players</button>
    <span id="config-status" style="color:#ccc;"></span>
  </div>
</div>

<script>
function showTab(name) {
  document.getElementById("service-panel").style.display =
    name === "services" ? "block" : "none";
  document.getElementById("tab-sindenlog").style.display =
    name === "sindenlog" ? "block" : "none";
  const cfg = document.getElementById("tab-config");
  if (cfg) cfg.style.display = name === "config" ? "block" : "none";
  if (name === "sindenlog") loadSindenLog();
  if (name === "config") {
    const sel=document.getElementById("platform-select");
    loadConfig(sel.value).catch(err => {
      const s=document.getElementById("config-status");
      if (s) s.textContent = "Load error: " + err.message;
    });
  }
}

async function refreshServices() {
  const res = await fetch("/api/services");
  const data = await res.json();
  for (const [name, status] of Object.entries(data)) {
    const row = document.getElementById("service-" + name.replace(".service",""));
    if (!row) continue;
    const statusEl = row.querySelector(".service-status");
    statusEl.textContent = status;
    statusEl.className = "service-status " + status;
  }
}
async function serviceAction(name, action) {
  await fetch(`/api/service/${name}/${action}`, { method: "POST" });
  refreshServices();
}
async function loadLogs(service) {
  const box = document.getElementById("logs-" + service.replace(".service",""));
  const content = box.querySelector(".log-content");
  const res = await fetch(`/api/logs/${service}`);
  const data = await res.json();
  content.textContent = (data && data.logs) ? data.logs : "No logs available";
}
function toggleLogs(service) {
  const box = document.getElementById("logs-" + service.replace(".service",""));
  const btn = event.target;
  if (box.style.display === "block") {
    box.style.display = "none";
    btn.textContent = "Show Logs";
  } else {
    box.style.display = "block";
    btn.textContent = "Hide Logs";
    loadLogs(service);
  }
}
async function loadSindenLog() {
  const res = await fetch("/api/sinden-log");
  const data = await res.json();
  const box = document.getElementById("sinden-log-content");
  box.textContent = data.logs;
  box.parentElement.scrollTop = box.parentElement.scrollHeight;
}

/* === Config (PS1/PS2) === */
document.addEventListener("DOMContentLoaded", () => {
  const sel = document.getElementById("platform-select");
  sel.addEventListener("change", () => {
    loadConfig(sel.value).catch(err => {
      const s=document.getElementById("config-status");
      if (s) s.textContent = "Load error: " + err.message;
    });
  });
});

async function loadConfig(platform) {
  const res = await fetch(`/api/config?platform=${encodeURIComponent(platform)}`);
  const data = await res.json();
  if (!data.ok) throw new Error(data.error || "Failed to read config");
  document.getElementById("config-file-path").textContent = data.path ? `File: ${data.path}` : "";
  buildConfigForm("p1-form", data.player1);
  buildConfigForm("p2-form", data.player2);
}
function buildConfigForm(containerId, kv) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";
  Object.keys(kv).sort().forEach(k => {
    const row = document.createElement("div"); row.className = "config-row";
    const label = document.createElement("label"); label.textContent = k;
    const input = document.createElement("input"); input.value = kv[k] ?? ""; input.dataset.key = k;
    row.appendChild(label); row.appendChild(input); container.appendChild(row);
  });
}
function collectForm(containerId) {
  const out = {};
  [...document.getElementById(containerId).querySelectorAll("input[data-key]")]
    .forEach(i => out[i.dataset.key] = i.value);
  return out;
}
async function saveConfig(platform, p1, p2) {
  const res = await fetch("/api/config/save", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ platform, player1: p1, player2: p2 })
  });
  return await res.json();
}
document.addEventListener("DOMContentLoaded", () => {
  const status = document.getElementById("config-status");
  const sp1 = document.getElementById("save-p1");
  const sp2 = document.getElementById("save-p2");
  const sb  = document.getElementById("save-both");
  const sel = document.getElementById("platform-select");

  if (sp1) sp1.onclick = async () => {
    status.textContent = "Saving Player 1...";
    const d = await saveConfig(sel.value, collectForm("p1-form"), {});
    status.textContent = d.ok ? `Saved. Backup: ${d.backup || "n/a"}` : `Error: ${d.error}`;
  };
  if (sp2) sp2.onclick = async () => {
    status.textContent = "Saving Player 2...";
    const d = await saveConfig(sel.value, {}, collectForm("p2-form"));
    status.textContent = d.ok ? `Saved. Backup: ${d.backup || "n/a"}` : `Error: ${d.error}`;
  };
  if (sb) sb.onclick = async () => {
    status.textContent = "Saving both players...";
    const d = await saveConfig(sel.value, collectForm("p1-form"), collectForm("p2-form"));
    status.textContent = d.ok ? `Saved. Backup: ${d.backup || "n/a"}` : `Error: ${d.error}`;
  };
});

setInterval(() => {
  ["lightgun.service", "lightgun-monitor.service"].forEach(s => {
    const box = document.getElementById("logs-" + s.replace(".service",""));
    if (box && box.style.display === "block") loadLogs(s);
  });
  if (document.getElementById("tab-sindenlog").style.display === "block") {
    loadSindenLog();
  }
}, 3000);
setInterval(refreshServices, 3000);

/* Default to Sinden Log on first load */
showTab('sindenlog');
refreshServices();
</script>
</body>
</html>
INDEX_EOF
sudo chown sinden:sinden /opt/lightgun-dashboard/index.html

echo "=== Downloading dashboard logo from GitHub ==="
sudo wget -O /opt/lightgun-dashboard/logo.png \
  https://raw.githubusercontent.com/th3drk0ne/sindenps/refs/heads/main/Linux/opt/lightgun-dashboard/logo.png
sudo chown sinden:sinden /opt/lightgun-dashboard/logo.png

echo "=== Creating Python virtual environment ==="
python3 -m venv /opt/lightgun-dashboard/venv
source /opt/lightgun-dashboard/venv/bin/activate

echo "=== Installing Python dependencies ==="
pip install --upgrade pip
pip install flask gunicorn

echo "=== Writing Flask app with PS1/PS2 Configuration API ==="
sudo bash -c 'cat > /opt/lightgun-dashboard/app.py' <<'APP_EOF'
import os, time, subprocess
import xml.etree.ElementTree as ET
from flask import Flask, jsonify, render_template_string, send_from_directory, request

app = Flask(__name__)

SERVICES = [
    "lightgun.service",
    "lightgun-monitor.service"
]

SYSTEMCTL = "/usr/bin/systemctl"
SUDO = "/usr/bin/sudo"

CONFIG_PATHS = {
    "ps2": "/home/sinden/Lightgun/PS2/LightgunMono.exe.config",
    "ps1": "/home/sinden/Lightgun/PS1/LightgunMono.exe.config",
}
DEFAULT_PLATFORM = "ps2"

def get_status(service):
    try:
        output = subprocess.check_output(
            [SYSTEMCTL, "is-active", service],
            stderr=subprocess.STDOUT
        ).decode().strip()
        return output
    except subprocess.CalledProcessError:
        return "unknown"

def control_service(service, action):
    try:
        subprocess.check_output([SUDO, SYSTEMCTL, action, service], stderr=subprocess.STDOUT)
        return True
    except subprocess.CalledProcessError as e:
        print("CONTROL ERROR:", e.output.decode())
        return False

@app.route("/api/services")
def list_services():
    return jsonify({s: get_status(s) for s in SERVICES})

@app.route("/api/service/<name>/<action>", methods=["POST"])
def service_action(name, action):
    if name not in SERVICES:
        return jsonify({"error": "unknown service"}), 400
    if action not in ["start", "stop", "restart"]:
        return jsonify({"error": "invalid action"}), 400
    ok = control_service(name, action)
    return jsonify({"success": ok, "status": get_status(name)})

@app.route("/api/logs/<service>")
def service_logs(service):
    if service not in SERVICES:
        return jsonify({"error": "unknown service"}), 400
    try:
        output = subprocess.check_output(
            [SYSTEMCTL, "status", service, "--no-pager"],
            stderr=subprocess.STDOUT
        ).decode()
        return jsonify({"logs": output})
    except subprocess.CalledProcessError as e:
        return jsonify({"logs": e.output.decode()})

@app.route("/api/sinden-log")
def sinden_log():
    LOGFILE = "/home/sinden/Lightgun/log/sinden.log"
    try:
        with open(LOGFILE, "r", encoding="utf-8", errors="replace") as f:
            data = f.read()
        return jsonify({"logs": data})
    except Exception as e:
        return jsonify({"logs": f"Error reading log: {e}"})

# ---------- Configuration API (PS1/PS2) ----------
def _resolve_platform(p):
    p = (p or "").lower()
    return p if p in CONFIG_PATHS else DEFAULT_PLATFORM

def _ensure_stub(path):
    # Create minimal XML stub if file is missing
    if not os.path.exists(path):
        os.makedirs(os.path.dirname(path), exist_ok=True)
        with open(path, "w", encoding="utf-8") as f:
            f.write('<?xml version="1.0" encoding="utf-8"?>\n<configuration><appSettings></appSettings></configuration>\n')

def _load_config_tree(path):
    _ensure_stub(path)
    return ET.parse(path)

def _appsettings_root(tree):
    root = tree.getroot()
    appsettings = root.find("appSettings")
    if appsettings is None:
        appsettings = ET.SubElement(root, "appSettings")
    return appsettings

def _kv_items(appsettings):
    return [el for el in appsettings.findall("add") if "key" in el.attrib]

def _split_by_player(appsettings):
    p1, p2 = {}, {}
    for el in _kv_items(appsettings):
        k = el.attrib["key"]
        v = el.attrib.get("value", "")
        if k.endswith("P2"):
            base = k[:-2]
            p2[base] = v
        else:
            p1[k] = v
    return p1, p2

def _ensure_key(appsettings, key):
    node = next((el for el in _kv_items(appsettings) if el.attrib["key"] == key), None)
    if node is None:
        node = ET.SubElement(appsettings, "add", {"key": key, "value": ""})
    return node

def _write_players_back(appsettings, p1_data, p2_data):
    for k, v in p1_data.items():
        _ensure_key(appsettings, k).set("value", str(v))
    for k, v in p2_data.items():
        _ensure_key(appsettings, f"{k}P2").set("value", str(v))

def _pretty_xml(tree):
    try:
        import xml.dom.minidom as minidom
        rough = ET.tostring(tree.getroot(), encoding="utf-8")
        reparsed = minidom.parseString(rough)
        return reparsed.toprettyxml(indent="  ", encoding="utf-8")
    except Exception:
        return ET.tostring(tree.getroot(), encoding="utf-8")

@app.route("/api/config", methods=["GET"])
def api_config_get():
    try:
        platform = _resolve_platform(request.args.get("platform"))
        path = CONFIG_PATHS[platform]
        tree = _load_config_tree(path)
        appsettings = _appsettings_root(tree)
        p1, p2 = _split_by_player(appsettings)
        return jsonify({"ok": True, "platform": platform, "path": path, "player1": p1, "player2": p2})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500

@app.route("/api/config/save", methods=["POST"])
def api_config_save():
    try:
        data = request.get_json(force=True) or {}
        platform = _resolve_platform(data.get("platform"))
        path = CONFIG_PATHS[platform]
        p1 = data.get("player1", {})
        p2 = data.get("player2", {})

        # backup
        ts = time.strftime("%Y%m%d-%H%M%S")
        backup_path = f"{path}.{ts}.bak"
        os.makedirs(os.path.dirname(backup_path), exist_ok=True)
        if os.path.exists(path):
            with open(path, "rb") as src, open(backup_path, "wb") as dst:
                dst.write(src.read())
        else:
            _ensure_stub(path)

        tree = _load_config_tree(path)
        appsettings = _appsettings_root(tree)
        _write_players_back(appsettings, p1, p2)

        xml_bytes = _pretty_xml(tree)
        with open(path, "wb") as f:
            f.write(xml_bytes)

        return jsonify({"ok": True, "platform": platform, "path": path, "backup": backup_path})
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500
# ---------- End Configuration API ----------

@app.route("/logo.png")
def logo():
    return send_from_directory("/opt/lightgun-dashboard", "logo.png")

@app.route("/")
def index():
    with open("/opt/lightgun-dashboard/index.html", "r", encoding="utf-8") as f:
        html = f.read()
    return render_template_string(html)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
APP_EOF
sudo chown sinden:sinden /opt/lightgun-dashboard/app.py

echo "=== Writing lightgun-dashboard systemd service ==="
sudo bash -c 'cat > /etc/systemd/system/lightgun-dashboard.service' <<'UNIT_EOF'
[Unit]
Description=Lightgun Dashboard (Flask + Gunicorn)
After=network.target

[Service]
User=sinden
WorkingDirectory=/opt/lightgun-dashboard
Environment="PATH=/usr/bin:/bin:/usr/sbin:/sbin:/opt/lightgun-dashboard/venv/bin"
ExecStart=/opt/lightgun-dashboard/venv/bin/gunicorn -w 2 -b 0.0.0.0:5000 app:app
Restart=always

[Install]
WantedBy=multi-user.target
UNIT_EOF

echo "=== Adding sudoers rule for systemctl ==="
sudo bash -c 'echo "sinden ALL=NOPASSWD: /usr/bin/systemctl" > /etc/sudoers.d/90-sinden-systemctl'
sudo chmod 440 /etc/sudoers.d/90-sinden-systemctl

echo "=== Ensuring XML configs are present & writable ==="
# create stub files if missing so UI works out-of-the-box
for p in PS1 PS2; do
  if [ ! -f "/home/sinden/Lightgun/$p/LightgunMono.exe.config" ]; then
    sudo mkdir -p "/home/sinden/Lightgun/$p"
    sudo bash -c "cat > /home/sinden/Lightgun/$p/LightgunMono.exe.config" <<'XML_EOF'
<?xml version="1.0" encoding="utf-8"?>
<configuration><appSettings></appSettings></configuration>
XML_EOF
  fi
  sudo chown sinden:sinden "/home/sinden/Lightgun/$p/LightgunMono.exe.config"
  sudo chmod 664 "/home/sinden/Lightgun/$p/LightgunMono.exe.config"
done

echo "=== Enabling dashboard service ==="
sudo systemctl daemon-reload
sudo systemctl enable lightgun-dashboard.service
sudo systemctl restart lightgun-dashboard.service

echo "=== Configuring Nginx reverse proxy on port 80 ==="
sudo bash -c 'cat > /etc/nginx/sites-available/lightgun-dashboard' <<'NGINX_EOF'
server {
    listen 80;
    server_name _;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
NGINX_EOF

sudo ln -sf /etc/nginx/sites-available/lightgun-dashboard /etc/nginx/sites-enabled/lightgun-dashboard

# Disable default site to avoid port 80 conflicts
if [ -L /etc/nginx/sites-enabled/default ]; then
  sudo rm /etc/nginx/sites-enabled/default
fi

# File permissions (readable to nginx)
sudo chown sinden:www-data /home/sinden/Lightgun/log/sinden.log
sudo chmod 644 /home/sinden/Lightgun/log/sinden.log

sudo nginx -t && sudo systemctl restart nginx

echo "=== Setup complete! Dashboard running at http://sindenps.local/ ==="
